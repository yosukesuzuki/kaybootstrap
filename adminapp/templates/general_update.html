{% extends "mainapp/base.html"%}
{% block title %}{{ title }}{% endblock %}
{% block description %}{% endblock %}
{% block content %}
<h1>{{ title }}</h1>
<div id="main">
    {% call form(class_='form-horizontal') %}
    {% for f in form %}
    <div class="control-group">
        {{ form[f.name].label(class_='control-label')|safe }}
        <div class="controls">
        {{ form[f.name].render(class_='input-block-level')|safe }}
        </div>
    </div>
    {% endfor %}
    <div class="form-actions">
        <button class="btn btn-large btn-block btn-primary" type="submit">{{_('Save')}}</button>
        {#{{ form.default_actions()|safe }}#}
    </div>
    {% endcall %}
</div>
<!-- Modal -->
<div id="imageInsertModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="imageInsertModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
    <h3 id="imageInsertModalLabel">{{_('Image Insert')}}</h3>
  </div>
  <div class="modal-body">
      <p>{{_('Select Images')}}</p>
      <div id="pagination"></div> 
      <ul class="thumbnails" id="images">
      </ul>
      <div style="display:none;" id="imageinserttarget"></div>
  </div>
  <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">{{_('Close')}}</button>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
    $('textarea').each(function(i,elem){
        elem.insertAdjacentHTML('beforeBegin','<a class="insertimage btn btn-small" targetid="'+elem.id+'"><i class="icon-picture"></i>{{_('Insert Image')}}</a>');
    });
    $('a.insertimage').live('click',function() {
        var imageinserttarget = $(this).attr('targetid');
        $('#imageinserttarget').html(imageinserttarget);
        $('#imageInsertModal').modal();
        showImageList(1);
    });
    $('a.imagepagination').live('click',function(){
        var page = $(this).text();
        showImageList(page);
    });
    $('div.thumbnail').live('click',function(){
        var imageinserttarget = $('#imageinserttarget').text();
        var image_source = $(this).find('img').attr('src');
        image_source = image_source.replace(/=s160/,'=s320')
        var image_title = $(this).find('h5').text();
        console.log(image_source);
        console.log(image_title);
        var insert_text = '!['+image_title+']('+image_source+')';
        $('#'+imageinserttarget).append(insert_text);

    });
    function showImageList(page){
        $('#images').html('');
        $.getJSON('/admin/image/list/json/?page='+page, function (result) {
            var pages = result.total_pages;
            var current_page = result.current_page;
            var pagination_html ='<div class="pagination"><ul>';
            for(var p=1;p<=pages;p++){
                //write pagination logic here
                if(p == page){var li_class='active';}else{var li_class=''}
                pagination_html += '<li class="'+li_class+'"><a href="javascript:void(0);" class="imagepagination">'+p+'</a></li>';
            }
            pagination_html +='</ul>';
            $('#pagination').html(pagination_html);
            var uploaded_images = result.images;
            for(var i =0; i < uploaded_images.length; i++){
                var temp_html = '<li class="span2">';
                temp_html += '<div class="thumbnail"><a href="#"><img src="'+uploaded_images[i].image_path+'=s160">';
                temp_html += '<h5>'+uploaded_images[i].title+'</h5></a></div>';
                temp_html += '</li>';
                $('#images').append(temp_html);
            }
        });
    }
</script>
{% endblock %}
